# 全体ToDo
- 参考：昨年度Flow：https://sites.google.com/site/ipbloit/private/home/ta/flow-of-ipbl

## 事前学習関連（井垣，宮脇，奥野，鎌倉）
- 物品購入（奥野）
  - 立て替え払い稟議
  - 国際センター予算15万，学部長裁量経費，さくら2万程度
- 資料作成（井垣，宮脇）
- TA指導，TA出欠確認（井垣が出欠シート作成，TA自身）
- 英語授業対応確認・連絡（鎌倉）
  - 学生に週2回必ず出席するよう指示する
  - 欠席が続いた場合は本番に参加できない可能性があることも伝える

## PBLWeek
### OIT外対応
- 以下は国際連携委員の委員会で調整してもらう
- お迎え@関空
  - ICOCA等交通費対応確認
    - 空港で希望者には https://kansaionepass.com/kf_pr/kf_pr_jp.html これを買ってもらう．返金も各自で．
  - 学生連絡先確認
  - 部屋の使い方，OITへの訪問方法説明
- 見送り@関空
- 日々の送迎（国際会館-OIT間)
  - 基本初日月曜日のみTAを1名手配する
  - 帰宅時のバスは参加学生・TAと一緒に
- エクスカーション
  - スケジュール決定・資料作成，付き添い，施設チケット・交通手段手配（バス予約？）・ランチ，参加学生連絡先確認

### OIT内対応
- オープニングセレモニー
  - 場所手配
  - 受付
    - WiFiアカウント，スケジュール資料印刷，学内Map作成・印刷（杉川）
  - プレゼント交換，Souvenir準備（奥野）
    - 教員向けプレゼント購入（奥野）
    - 国際センターから工大グッズ受領（奥野）
    - さくらグッズ受領（奥野）
  - 式次第調整（奥野）
  - アイスブレイク準備（泉）
    - 自己紹介，チーム名・ロボット名決定
    - 井垣から昨年度資料渡す
- ウェルカムパーティ（神野・辻）
  - マイク，プロジェクタ（必要なら）手配
  - スピーチ担当者決定
  - 食事手配（必要ならビール追加）
  - 関連教員の招待（英語教員等）
- 開発関連（井垣，宮脇）
  - スケジュール決定，教員予定割当（事前学習：井垣，PBL week：奥野）
  - OIT-SIIT交流開発，mini game，Final Competition準備
    - mini game, final competition運用の確認（審判，スコア評価方法チェック）
  - 広報連絡・受け入れ（安留）
- 修了式
  - 修了証印刷（安留）
  - 各種アンケート準備（奥野）
  - 式次第決定（奥野）

# 準備器材
## 4/14まで
### 8ペア分(最終的には5チーム(各2セット)分)
- WindowsノートPC
- Gopigo kit (ロボット部分)+picamera
- 単３電池16本+充電器
- 電源タップ
- ***LANケーブル 5m(要購入)***
  - http://www2.elecom.co.jp/products/LD-GPYTBK05.html
  - 購入せず，奥野研，中西（知）研学生TAに作成してもらうことになった

### 全体向け
- ***無線LANルータ+ACアダプタ(要購入)*** * 1
  - http://buffalo.jp/product/wireless-lan/pro-ap/wapm-1266r/
  - http://buffalo.jp/product/wireless-lan/pro-option/wle-op-ac12c/
- ***エネロイド(充電器)(要購入)*** * 3~4
  - http://www.kenko-tokina.co.jp/pc/battery/mbc/4961607473122.html
  - 充電済み電池，未充電電池を入れる箱を作る

## 5/12まで
### 8ペア分
- ***blue, green, redの色紙(要購入)***
  - 4枚ずつ色紙を買って，ハサミで半分にするとかでも良いかも
  - PBL week中は不要

## 5/26まで
### 8ペア分(最終的には5チーム(各2セット)分)
- ***USB web camera(要購入?)***
  - 鎌倉研Web Camera*10で対応する（今後のことを考えるとどこかで購入したほうが良いかも）
  - 全チーム同じWebカメラが望ましい（ドライバが共通化できるため）
  - 要三脚穴
- ***USB延長ケーブル(5m x 10本)(要購入)***
- ***オートポール＋アングルを固定するクランプヘッド(要購入)***
  - 現在8本あり？
- ***アングル(1チームに1つ)(要購入)***
  - オートポール間に渡すやつ．Webカメラが固定できるようになっているもの
  - 長さ最低1.6~2m程度必要
- ***USBカメラをアングルに固定する金具(要購入)***
- ***vs-marker,target用小道具(要購入)***
  - 以下はPBL week開始時物品なので，5/26時点ではもう少し少なくても良い（1/3程度)
  - 白プラダン
    - 40cm*45cm を15枚分(target)
    - 12cm*12cm を10枚分(vs-marker)．一部はtarget用白プラダンから流用
  - 緑プラダン(Target)
    - 10cm*15cmを5枚
  - 青プラダン(Target)
    - 10cm*15cmを5枚
  - 黃プラダン(Target)
    - 10cm*15cmを5枚
  - 赤プラダン(Guard)
    - 20cm*30cmを5枚分
- ***両面テープ(要購入)***
  - Guard, vs-marker
  - 白プラダンにvs-marker貼り付け用,マジックテープ用
- ***マジックテープ(要購入)***
  - 2m程度
  - vs-markerをgopigoに固定する
  - Guardをgopigoに固定する
- ***白ガムテープ(要購入)***
  - 10m程度
  - Target作成用
  - Target置き用発泡スチロール固定用（養生テープのほうが良いかも）
- ***発泡スチロール台(要購入)***
  - 色は白？
  - 高さ20cm程度になるような台
  - 10cm x 15cm x 30cmのTargetと同じ数必要(15セット)
- 3m程度の木の板（2017年度のものがあれば）
  - 10本あれば，5フィールドの両端に置ける
- **Nuboard(できれば購入したい)** 
  - ポータブルなホワイトボード A3版
  - チームに1つずつあれば議論が捗るかも
  - https://obun.jp/stationery/nuboard/nuboard_standard/

# 教員・TA作業内容
## 4/14,4/21,4/25,5/9
- 予備Gopigo組み立て
- WindowsノートPCセットアップ
  - 水曜日の学生がいないチームのものを順にセットアップしていく
  - MS Office(特にppt)
  - JDK8
  - eclipse oxygen
  - Rlogin.exe
  - UltraVNC
  - logicool Webcamera driver及びソフトウェア
  - vision systemが動くようにeclipseにimportしておく
- Gopigo Basic Setup資料及びImage Processing資料の実施確認
- Image Processing用色紙用意
## 5/12,5/16,5/23
- vision system用環境構築
  - オートポール，クランプ，アングル，USBWebカメラ及びアングルへの固定，延長USBケーブル設置
  - 試行
- 以降は5/26時点ではすべて完成している必要はない
- vs-marker*35枚分印刷
- vs-markerを12cm角白プラダンに両面テープで貼り付け
- Target15個分作成
- Guard10枚分作成
## 5/26,6/6,6/13
- ↑作業のうち残りを作成
- Final Competition向け評価用プログラム及びFinal Competition運用方法の確認

# Mini Game,Final Competition等仕様及び準備
## 事前学習最終課題
### [***Final Exercise***] Shoot the green and the blue targets.(vsgocv04.py)
- Prepare 2 targets(blue and green) and 1 vs-marker at start place.
- First, Gopigo will rotate, approach, face and shoot the **green** target.
- Gopigo will shoot and save the image of the green target.
  - cx of the target exists between 200px~440px
  - area of the target is over 10000px.
  - image is named ``cap_01.jpg``
- Gopigo will return to the start place.
- Next, gopigo will shoot the **blue** target like the green target, and save the image named ``cap_02.jpg``.
- Gopigo glows the LEDs blue while gopigo is heading to the blue target and glows the LEDs green while gopigo is heading to the green target.
- Finally, gopigo will return to the start place.

## Mini Game
- PBL week2日目に向けた課題
- OIT生がタイ学生に説明し，それをベースに協力して開発してもらうイメージ
- 青，緑，黃の3色のターゲットがある．それぞれ10枚ずつ写真を撮影する
- 位置，画像サイズはこちらから指定する
- 制限時間3分
- Guardは頑張って防ぐ

## Final Competition
- 複数色の的を撮影する
- 撮影された画像を時系列順にソートし，連続して異なる色の的を撮影した場合にポイントとする
  - 赤->赤->青->黃->青->青->赤，の場合，5ポイントになる
- 基本的にはちょっとでも写ってたらOKだが，最低ピクセルサイズは決めておきたい
- イレギュラー時にはスタート地点に戻す（時計は止めない）
- 制限時間は6分
- 操作はロボットスタート時のみ

### 色判定
- 実際にターゲット撮影画像を複数枚用意して検証してみる必要がある．第2案をベースに検討中．
- ゲーム中リアルタイムに実施するのは断念する（Vision Systemで採点する方法が見つかれば良いが，とりあえずは各ゲーム終了時にShooterのGopigo上で採点スクリプトを実行する形で行う）
- スコアの基準は撮影画像を縦で1/3ずつに区切り，中央1/3の中に一定ピクセル以上のサイズの赤/青/緑のいずれかのターゲットが含まれていればその画像をOK画像とする．OK画像を時系列で並べたときに，連続して異なる色が撮影されていた場合にポイントを加算し，トータルポイントをShooterの得点とする．
- 採点スクリプトとしては，H値と画像を入力として与えると，OK/NGに分けた画像及びスコアの計算結果を出力するものを想定している．OK/NGが画像を見るだけで分かるように，1/3の補助線と認識されたターゲットの領域及びピクセル数がオーバーレイされていると良い．
- ここまで書いてて思ったんですが，ゲーム終了時にShooterのGopigoにsshで接続して，画像を全部手元にDLする．その画像を対象に学生から聞いたH値を適用して評価スクリプトを実行すれば採点できますかね？これができるならSA用のPCを用意しておいて，そこにpython+opencvとscpクライアントインストールしておけば，比較的かんたんにチェックできるかなと思いました．あとはまぁpycファイル（ただし自動採点まではせず，画像に1/3のラインと色とピクセル値を重ねて表示する程度のもの）を学生に渡しておいて，自分たちで練習試合ができるようにするとか．

-----
# 過去のメモ
- 以下は過去のメモ．とりあえず置いておく．

## 必要物品に関する情報整理
- 全体向け
  - **Buffalo無線LANルータ**
    - 部屋で利用可能か要確認
- 1チーム5名*5チーム
- 1チームあたりの物品
  - Gopigo 2台
    - 各Gopigoあたり，**無線アダプタ（デフォルト:Buffaloのやつも調べる）**，単3充電池8本，USB電源ケーブル＆アダプタ，Piカメラ1つ，Piカメラ固定具1つ(宮脇先生謹製)，**LANケーブル1本(3m,5mで柔らかいor細い奴の色違い)**，単3エネループ充電器8本分，vision system用マーカー（本体貼り付け）関連消耗品（両面テープ＋白プラダン）*2，防御側gopigo用ガード(これも両面テープ+黒プラダン Piカメラ固定具に両面テープ貼り付ける)
    - 単3充電用に[**エネロイド**](http://www.kenko-tokina.co.jp/pc/battery/mbc/4961607573129.html)2~3台買っておいても良いかも
  - vision system関連
    - USB Webカメラ（Logicool C615?要調査）2台，**USB延長ケーブル2本(5m)**
    - ~~オートポール2本+クランプ2個＋アーム2本~~
    - **オートポール2本+アングル2mのものを1本+クランプ2個+Webカメラ固定具2つ**
    - vision systemマーカー用プラダン
    - マーカー台用発泡スチロール
  - フィールド関連
    - ターゲット3つ分(プラダン等で加工できるものなので，数万円程度の消耗品費用があれば十分かと)
    - 外壁はどうするか要検討．何らかの壁は必要（ターゲットを貼るために）．プラダン＋ターゲット貼らない部分は机に布をかける方式でいくなら，サイズ検討が必要．
    - ターゲット下に発泡スチロールを積み上げる案
## 組み立て
- GopiGo
  - 宮脇先生謹製のPiカメラ固定具（前と上の2パターンあり，今のところ上パターンがよいか）
  - visionsystem用マーカー(vs-Marker)を上面に固定．マーカーサイズのプラダンを用意し，プラダンごとマジックテープで付け外しが簡単にできるようにしておけば，電池やPiカメラ固定具との干渉（前者は物理的なもの，後者はvision systemから撮影時に固定具が邪魔でvsマーカーが見えにくくなるもの）をある程度排除できるきがする．
  - Guard板も同様に前面にカメラ及びLANケーブルの差込口と重ならないように（LANケーブル分の切り欠きでも良い）プラダンを貼り付けるようにしておけば良い．高さ，横幅のサイズについては今後の検討課題．ターゲットマーカー(T-Marker)にピッタリくっついたときに，すべては隠せない程度の高さが望ましい？
### フィールドについて
- USBカメラはC615以降のもので三脚がついているものが望ましい．これまで国際PBL用として購入していたものは穴がない．そのため， @kama 先生に貸与頂くかも．
- 現状井垣が所有しているアームとオートポールの組み合わせだと，USBカメラが安定せず，天井近くに設置できない．そのため，200cm程度のアングルをホームセンターで購入し，監視カメラ等を固定する器具（球体関節が2つついているもの）とアングルを接続した状態で，2本のオートポールの間に渡してやると天井近辺でいけそう．
- フィールドのサイズは1.5m*2.5m程度にする．
- 周囲は机及び黒い布で囲みたい
### ターゲットについて（撮影対象）
- 色は赤，青，緑の3種類で検討中．色ではなくARマーカーのようなものでも良いかもだが，個人的にはせっかくならOpencv使わせたい
- ターゲットの奥行きを30cm程度にしてみる．床からの高さは22.5cm程度（恐らく20cmで良い），ターゲット感の感覚は75cm程度にする．Shooterのスタートポイントから簡単には取れない位置に置くことに注意する．
- ↑で不十分な場合は現状10cm*10cmのターゲットを細長くすることも検討する．
- ターゲットはスチロールブロックを積み上げて設置する（ブロックは床に養生テープで貼り付けるイメージ）
- ターゲットの色はプラダンを想定．30cmの奥に色プラダンを貼り付け，30cmの上があいた直方体を白プラダンで作成する．色プラダン反対側（ターゲット手前部分）あたりにvs-Markerを上に貼り付ける

### Gopigoについて
- Shooter/Guard両方共Piカメラは高い方の固定具にする
- ガードは黒のプラダンで20cm*30cm目安（事前学習時に要チェック）で作成する．Piカメラの緑の影響を受けないように，緑色の部分まで隠し，レンズだけ開放したデザインにする．カメラ固定具にマジックテープで接続する
- Shooter/Guard両方共上部にvs-Markerをマジックテープで貼り付ける．

## その他ルール等
- 決めるべきルールはpre-training用Pre Game，受け入れ時Mini Game，Final Competitionの3種類
### Pre Game
- スタート地点から特定のマーカーの場所まで移動し，的を撮影してスタート地点まで戻る
### Mini Game
- 全部同じ色のマーカーを壁に配置し，攻撃側はそれを撮影する
- 防御側は防御側フィールド内を移動し，撮影を防ぐ．
- 撮影したマーカーの画像枚数で勝負

### Final Competition
- 複数色の的を撮影する
- 撮影された画像を時系列順にソートし，連続して異なる色の的を撮影した場合にポイントとする
  - 赤->赤->青->黃->青->青->赤，の場合，5ポイントになる
- 横長のフィールド（短い方でも2mは確保する）
- 防御側はダンボール壁を用意（白or黒プラダンでもOK)
- 基本的にはちょっとでも写ってたらOKだが，最低ピクセルサイズは決めておきたい
- 1m地点両脇にマーカーをおき，攻撃・防御はそこまでの範囲で行う
- イレギュラー時にはスタート地点に戻す（時計は止めない）
- 制限時間は10分程度？
- 操作はロボットスタート時のみ
### 色判定
- 実際にターゲット撮影画像を複数枚用意して検証してみる必要がある．第2案をベースに検討中．
- ゲーム中リアルタイムに実施するのは断念する（Vision Systemで採点する方法が見つかれば良いが，とりあえずは各ゲーム終了時にShooterのGopigo上で採点スクリプトを実行する形で行う）
- スコアの基準は撮影画像を縦で1/3ずつに区切り，中央1/3の中に一定ピクセル以上のサイズの赤/青/緑のいずれかのターゲットが含まれていればその画像をOK画像とする．OK画像を時系列で並べたときに，連続して異なる色が撮影されていた場合にポイントを加算し，トータルポイントをShooterの得点とする．
- 採点スクリプトとしては，H値と画像を入力として与えると，OK/NGに分けた画像及びスコアの計算結果を出力するものを想定している．OK/NGが画像を見るだけで分かるように，1/3の補助線と認識されたターゲットの領域及びピクセル数がオーバーレイされていると良い．
- ここまで書いてて思ったんですが，ゲーム終了時にShooterのGopigoにsshで接続して，画像を全部手元にDLする．その画像を対象に学生から聞いたH値を適用して評価スクリプトを実行すれば採点できますかね？これができるならSA用のPCを用意しておいて，そこにpython+opencvとscpクライアントインストールしておけば，比較的かんたんにチェックできるかなと思いました．あとはまぁpycファイル（ただし自動採点まではせず，画像に1/3のラインと色とピクセル値を重ねて表示する程度のもの）を学生に渡しておいて，自分たちで練習試合ができるようにするとか．
- 過去の案その1
  - Targetが撮影画像の中心線（両脇から均等の距離にある線）に重なっているか．ただし，撮影画像内で最も面積が大きいTarget一つを対象とし，その大きさは？ピクセル以上
    - 対象領域が中心点（あるいは中心線）に重なっているかどうかを判定する際に，あまりに小さい点でもOKにしてしまうと，対象領域（ターゲット）以外を判定してしまう可能性が上がる．
- 過去の案その2
  - 撮影画像の両脇から1/3の距離に線を2本引き，その線の間にTargetが存在するかどうか．ただし，撮影画像内で最も面積が大きいTarget一つを対象とし，その大きさは？ピクセル以上
- 評価関数の仕様
  - 画像(opencvで解釈可能なもの)を引数として渡すと，判定結果がOKの場合は色(カラーごとの番号を決めておいて青なら1，黃なら2とかを返させる（vision system marker番号と可能ならあわせる）)とTrueを帰し，NGの場合は0とFalseを返す．


# やったこと
- python2系での開発環境構築を目指す

## raspberry piの設定とgopigo環境のupdate
- https://www.dexterindustries.com/howto/install-raspbian-for-robots-image-on-an-sd-card/
  - これを参考にする．

- Raspbian for RobotsをDLする)(2017/10月のものをソースフォージから落とした)

- GopigoのSDカードをPCのUSBにさす．
  - フォーマットしろとか言われたが気にしないでおく
- Etcherを利用してRaspbian for Robotsをインストール(zipのままでOKっぽい）
- 有線でLANケーブルを接続し，IEでhttp://dex.local/にアクセス
  - http://169.254.27.204/ でもOKだった
  - なぜかChromeではnoVNCがうまく動かず
  - 以下のような事例もあったらしい↓
    - GoPiGoのIPアドレスを指定してアクセスするときは、GoogleChromeで問題なくアクセスできるんですが、LANケーブルで接続して、http://dex.local を指定してアクセスするとGoogleChromeの場合強制的にリダイレクトされて https://dex.local になり、アクセスできません。なので、最初のWiFi設定のためのアクセスの時だけInternetExplorerで、その後の作業はIPアドレスを指定して、GoogleChromeでアクセスしていました
- https://www.dexterindustries.com/GoPiGo/get-started-with-the-gopigo3-raspberry-pi-robot/2-connect-to-the-gopigo-3/Raspbian-For-Robots-Operating-System/
  - これを参考にWifiをセットアップ．(Wifiで取得されたIPで，vncに繋がるか確認しておく)
  - 同じネットワークに複数のGopigoがあったらどうなるかを要確認（多分ConflictするのでIPで指定するしかないような気がする）．
- WiFi接続後，DI Software Updateを実行．下記をやってから再起動．
  - Update Dexter 
    - License系はqで抜けて
    - updateするか残すかの質問（デフォルトはNo）についてはNoとしておく
  - Update Robot(Gopigo3)
    - Software update後にUpdate Robotしておいたほうがいいかも(ファームのバージョンが1になる）
- この時点でgopigoが動作するかテスト``git clone https://github.com/igakilab/gopigo.git``
  - ``python run10cm.py``が動作することを確認した
- aptのupgradeとupdate(これも最初にやっておくべき)
  - ``sudo apt-get upgrade``
  - ``sudo apt-get update``
- 時計の同期がおかしいので修正
  - https://www.raspberrypi.org/forums/viewtopic.php?t=195691
   - これを参考にtimedatectlの設定を変更してみたが・・．なんか3時間くらいずれたまま＞＜
   - 何もしなくても同期がちゃんと取れてる場合もあった．謎．
- ラズパイ設定を変更しておく（最初にやっておくべき）
  - ``sudo raspi-config``
  - 起動設定をDesktop Autologinにし，timezoneをAsia/Tokyoにする．あと，Expand filesystemも実施すると容量に余裕ができる
    - Boot Options => Desktop / CLI => Desktop Autologin
    - Advanced Options->Expand Filesystem
- x11vncをインストール及びセットアップ
  - https://raspberrypi.akaneiro.jp/archives/463
  - ``sudo apt-get install x11vnc``
  - 自動起動設定と解像度設定もやっておく
- 自動起動設定``~/.config/autostart/x11vnc.desktop``
```
[Desktop Entry]
Encoding=UTF-8
Type=Application
Name=X11VNC
Comment=X11VNC
Exec=x11vnc -usepw -forever
StartupNotify=false
Terminal=false
Hidden=false
```
- /boot/config.txt の framebuffer_width, framebuffer_height で解像度を指定してから再起動．
- display Noが何になるかわからないので，UltraVNCで``169.254.27.204::5900``にアクセスすればいいっぽい．
    - ↑と思ってたんだけど，5900でtightvncのほうと同じ画面に繋がることもあった．その場合は:2とかでやると別画面になったが，正しいかどうかは不明．
    - ``ps aux | grep vnc`` でtightvncを殺すとx11vncのみになるが，5900ポートでアクセス出来ない場合がある．その場合は``:0``~``:2``を試すとどれかでは繋がる
  - ``git clone https://github.com/igakilab/gopigo.git`` このリポジトリの``capture.py`` にpicameraのcamera.start_preview()を追加して実行した場合，tightVNCでもx11vncでも今のところプレビュー画面は表示されない．gpicviewでの画像表示はOK．x11vncでopencvのプレビューが表示されるかは今後確認する．

## サンプルDLとエディタの用意
- 以下のSampleコードをチェックアウト
  - ``git clone https://github.com/igakilab/oreo.git``
  - ``git clone https://github.com/igakilab/gopigo.git``
  - ``git clone https://github.com/KMiyawaki/gopigo_memo.git``
- geanyを起動．メニューからでも起動できるが，geanyコマンドでも起動できる．
  ``geany [filename] &``
- geanyのFontの設定は[Edit]->[Preferences]->[Interface]->[Fonts]で変更できる
- geanyの設定変更
  - ``/home/pi/.config/geany/filedefs/filetypes.python``
  - Working Directryがdefaultでは``/home/pi/Dexter/tmp/`` になっているので修正しておく
    - ``EX_00_WD=/home/pi/Dexter/tmp``を``EX_00_WD=``に変更する
  - indentの設定
    - [indentation]セクションのwidth=4, type=0の各行のコメントアウトを外す

## gopigo run とキー入力
- とりあえず走らせる ``run10cm.py``あとAPIの説明
  - py-getchを使うかどうか要検討
- キー入力ライブラリのセットアップと実行
  - ``sudo pip install py-getch``
  - gopigo.git の keycontrol.pyが実行できるようになる ``python3 keycontrol.py``
  - keycontrolはこの段階ではやめるかも．cv2のwaitKeyのみを利用するほうが分かりやすい気がする
- picamera
  - gopigo.gitのcapture.pyを実行
    - x11vncでもstart_preview()実行時に画面は表示されなかった

## Image Processing
### OpenCVインストール
- ```sudo apt-get install python-opencv``` ではpython2用のopencvがインストールされる
- インストール後に``sudo apt-get update`` しておく

### Video設定
- https://kmiyawaki.github.io/gopigo_memo/
- https://www.dexterindustries.com/GoPiGo/projects/python-examples-for-the-raspberry-pi/browser-video-streaming-robot-gopigo3/
- この説明で git clone をする必要はないらしい．
```
$ cd ~/Desktop/GoPiGo3/Projects/RemoteCameraRobot``
$ sudo bash install.sh
```
- リブート
- これで　/dev/video0 も入るとのこと
- ここまででopencvの画面は正常に表示されることが確認できた

### 例題等
- 実施確認サンプル
  - opencv00.py
  - b-opencv01.py
    - 最終的にはc-opencv01.pyにするか，カメラだけの説明をどこかで追加するかも
  - b-opencv02.py:skin detect
  - b-opencv03.py:detect contours
  - opencv_color_samply.py:BGRtoHSV
  - b-opencv04.py:Detect center and the size for each contour
  - color_picker.py
  - exercise検討
    - red,greenを対象としたcontour及びcenter,size指定
    - 指定した位置にred or greenのオブジェクトがあるときに画像ファイルred.jpg, green.jpgを保存する

## Simple Gopigo and opencv
- gopigoの基本APIを幾つか利用する
  - http://gopigo3.readthedocs.io/en/master/api-basic.html#easygopigo3
  - set_speed():0~1000
  - get_speed()
  - reset_speed()
  - stop()
  - backward()
  - right()
  - left()
  - forward()
  - drive_cm():blocking or non blocking
  - target_reached()
  - reset_encoders()
  - read_encoders()
  - turn_degrees()
- Keycontrol
  - b-keycontrol.py
  - keycontrol_curses.py
    - curses版を一応作ってみた．opencvと組み合わせるなら不要かも．
  - b-keycontrol_capture.py
    - opencv版画像保存サンプル．ただし，何かWindowを作成しないとキー入力を受け付けない
    - これを利用してリモートコントロールする場合は無線で接続できるようにしておかないとダメ
  - c-keycontrol_capture.py
    - opencv版の画像保存サンプル．bとの違いはPiRGBArrayを利用してbgr値の画像をいきなりcaptureしているところ．bよりもこっちのほうがだいぶパフォーマンスが良くなっている．
    - ref: https://raspberrypi.stackexchange.com/questions/24232/picamera-taking-pictures-fast-and-processing-them
- 指定距離進む系
  - drive_cm():defaultがブロッキング
    - 原則このあたりも全部ノンブロッキングにするか・・
  - turn_degrees():defaultがノンブロッキング
- encoder sample
  - encoder_sample.py
  - time.sleep(0.01)のところを0.05とかにするとtarget_reachedがTrueにならなくなる
    - 理由はわからないけど，指定した値近辺をチェックできないとスルーするっぽい？
  - forward+encorder
  - turn_degrees+encorder
  - drive_cm+encoder
    - non blockingに変更したものも試してもらう
- opencvとの連動系
  - 50cm前進し，停止してから自動的に写真を撮影したあと，50cmバックするプログラムを作成せよ
  - Gopigoを起動するとその場で回転し，赤いターゲットを発見するとその方向に50cm進んでから写真を撮影するプログラムを作成せよ
  - Gopigoを起動するとその場で回転し，まず赤いターゲットを発見してその方向に50cm進んで撮影してから同じ距離後進する．次にまたその場で回転し，今度は青いターゲットを探してその方向に50cm進んで撮影してから，また同じ距離後進するプログラムを作成せよ．

## Vision System
### 準備
- ハードウェア 
  - Logicool Webcam C615
  - [サポートソフトウェア](http://support.logicool.co.jp/ja_jp/product/hd-webcam-c615/downloads)をインストールしておく
    - DetectMarkerServer起動後に設定ソフトウェアをタスクトレイから起動し，オートフォーカス，オートゲイン，オートホワイトバランスを切っておく（最初はオートフォーカスを切って，最も遠景側にしておくだけでもいいかも）
- ソフトウェア
  - eclipseとjdk
  - [DetectMarkerServer本体](https://github.com/igakilab/DetectMarkerServer)
    - lib/djs.dllをjava.homeのbinフォルダにコピーする
  - eclipseからDetectMarkerServerフォルダを開く
  - `src\DetectMarkerServer.java`を右クリック->[Run As]->[Run Configurations]->[Arguments]->[VM arguments]に`-Xss64m -Xms64m -Xmx64m`と入力しておき，[Run]を実行すれば正常に動作する
  - `src\capture\DJSCapture.java`
    - L30あたりのCameraIdを必要に応じて変更する（1台しかカメラがささってなければ0)
  - `src\MarkerDetector.java`
    - `MIN_MARKER_SIZE=10,MAX_MARKER_SIZE=40`に設定しておく
    - Markerをオリジナルの縦横比2倍で印刷すると，概ね天井付近からでも認識することを確認．その場合3m*2m程度のフィールド（横方向の解像度のほうが大きいので横に広いフィールドにするのもありかも）は確保できる．
- 通信
  - ノートPCの無線IPをipconfigコマンドで調べる
    - 有線のIPだとケーブルを抜くとつながらないので注意
  - 確認のため，GopiGo内からpingが通るか確認しておく
  - DetectMarkerServer.javaを起動後，`nc -v -w 1 169.254.179.215 -z 7777`のようなコマンドでソケット通信が可能かどうかを確認できる
    - ネットワークの種類が「パブリックネットワーク」になっていると通信できない．``ネットワークと共有センター``を見るとどのネットワークがどれになっているか確認できるため，要チェック．
      - https://github.com/oblique/create_ap の利用も検討中
  - 通信が成功すると[response = 0 93.5 223.0 0.09053574604251853 -0.9958932064677039]のような返答がサーバから返ってくる
    - socket_client.py
    - 一行あたり一つのマーカー
    - marker.getID() + " " + location.getX() + " " + location.getY() + " " + orientationY.getX() + " " + orientationY.getY()
    - locationは解像度640*480で原点左上にしたときのマーカー座標を返す
    - orientationは±1の範囲でxは右が正，左が負，yは下が正，上が負の値で向きを示す．
### Gopigoとの連携
- GopiGoの向きを特定Targetに向ける
  - GopigoのMarkerの位置と特定Targetの位置から，Gopigoが向くべき方向を算出する
- Gopigoを特定Targetに向かせたあと，停止して撮影する
- Gopigoを特定Targetに向かせたあと，停止して撮影し，評価する
- GopiGoを特定Targetに向かせたあと，撮影し，Targetが中心に来るようにGopiGoを回転し，再度撮影する
- vs-Markerの情報に従ってGoPiGoの向きを変える
- vs-Markerの情報に従ってGoPiGoを移動させる
- vs-Markerの情報に従ってGoPiGoを移動させ，元の場所に戻す
- vs-Markerの情報に従ってGoPiGoを移動させ，画像を撮影させて元の場所に戻す
- vs-Markerの情報に従ってGoPiGoを移動させ，画像を連続して撮影して評価結果がOKの画像を保存して元の場所に戻る

# やったこと（過去の遺物）
- python3系で開発環境を構築しようとしたが，opencvがインストールできなかったので断念した．メモは残しておく．
- https://www.dexterindustries.com/howto/install-raspbian-for-robots-image-on-an-sd-card/
  - これを参考にする．

- Raspbian for RobotsをDLする)(2017/10月のものをソースフォージから落とした)

- GopigoのSDカードをPCのUSBにさす．
  - フォーマットしろとか言われたが気にしないでおく
- Etcherを利用してRaspbian for Robotsをインストール(zipのままでOKっぽい）
- 有線でLANケーブルを接続し，IEでhttp://dex.local/にアクセス
  - http://169.254.27.204/ でもOKだった
  - なぜかChromeではnoVNCがうまく動かず
  - 以下のような事例もあったらしい↓
    - GoPiGoのIPアドレスを指定してアクセスするときは、GoogleChromeで問題なくアクセスできるんですが、LANケーブルで接続して、http://dex.local を指定してアクセスするとGoogleChromeの場合強制的にリダイレクトされて https://dex.local になり、アクセスできません。なので、最初のWiFi設定のためのアクセスの時だけInternetExplorerで、その後の作業はIPアドレスを指定して、GoogleChromeでアクセスしていました
- https://www.dexterindustries.com/GoPiGo/get-started-with-the-gopigo3-raspberry-pi-robot/2-connect-to-the-gopigo-3/Raspbian-For-Robots-Operating-System/
  - これを参考にWifiをセットアップ．(Wifiで取得されたIPで，vncに繋がるか確認しておく)
  - 同じネットワークに複数のGopigoがあったらどうなるかを要確認（多分ConflictするのでIPで指定するしかないような気がする）．

- 接続後，DI Software Updateを実行．下記をやってから再起動．
  - Update Dexter Software
  - Update Robot(Gopigo3)
    - Software update後にUpdate Robotしておいたほうがいいかも(ファームのバージョンが1になる）

- aptのupgradeとupdate(これも最初にやっておくべき)
  - sudo apt-get upgrade
    - opencvがインストール出来ないので試しにupgradeしないでおいてみる
  - sudo apt-get update
- 時計の同期がおかしいので修正
  - https://www.raspberrypi.org/forums/viewtopic.php?t=195691
   - これを参考にtimedatectlの設定を変更してみたが・・．なんか3時間くらいずれたまま＞＜

- x11vncをインストール及びセットアップ
  - https://raspberrypi.akaneiro.jp/archives/463
  - ``sudo apt-get install x11vnc``
  - 自動起動設定と解像度設定もやっておく
  - display Noが何になるかわからないので，UltraVNCで``169.254.27.204::5900``にアクセスすればいいっぽい．
    - ↑と思ってたんだけど，5900でtightvncのほうと同じ画面に繋がることもあった．その場合は:2とかでやると別画面になったが，正しいかどうかは不明．
  - ``git clone https://github.com/igakilab/gopigo.git`` このリポジトリのcapture.py にpicameraのcamera.start_preview()を追加して実行した場合，tightVNCでもx11vncでも今のところプレビュー画面は表示されない．gpicviewでの画像表示はOK．x11vncでopencvのプレビューが表示されるかは今後確認する．

- ラズパイ設定を変更しておく（最初にやっておくべき）
  - ``sudo raspi-config``
  - 起動設定をDesktop Autologinにし，timezoneをAsia/Tokyoにする．あと，Enlarge SDCardも実施すると容量に余裕ができる
    - Boot Options => Desktop / CLI => Desktop Autologin


- 以下のSampleコードをチェックアウト
  - ``git clone https://github.com/igakilab/oreo.git``
  - ``git clone https://github.com/igakilab/gopigo.git``
  - ``git clone https://github.com/KMiyawaki/gopigo_memo.git``

- geanyを起動．メニューからでも起動できるが，geanyコマンドでも起動できる．
- geanyのExecute実行の設定を変更しておく（F5でpythonのスクリプトが実行できるようになる）
  - ``python hoge.py``だと実行できないので，python3で実行するように変更する
  - [Build]->[Set Build Commands]
  - Change setting[Execute] ``sudo python "%d/%f"`` into ``sudo python3 "%d/%f"``
  - 再起動するとpythonに戻ってしまう．要検討↑

- キー入力ライブラリのセットアップ
  - ``sudo pip3 install getch``
    - gopigo.git の keycontrol.pyが実行できるようになる ``python3 keycontrol.py``



### OpenCVセットアップ
- ```sudo apt-get install python-opencv``` ではpython2用のopencvがインストールされるが，python3で使えるopencvのライブラリがインストールされず
- pipやpip3では，``Could not find any downloads that satisfy the requirement opencv-contrib-python``となる
- ここに正規(Dexter)のopencvチュートリアルがあり，opencvが導入されたイメージが置いてあるが，16GBのサイズなので，32GBのmicrosdが多分必要
    - https://www.dexterindustries.com/gopigo-in-python-tutorials/
- これを試し中
  - https://qiita.com/nanbuwks/items/422eb405ceef84826ab4

```
$ cd ~
$ git clone https://github.com/Itseez/opencv.git
$ cd opencv
$ git checkout 3.4.0
$ cd ..
$ git clone https://github.com/Itseez/opencv_contrib.git
$ cd opencv_contrib/
$ git checkout 3.4.0
$ cd ..
$ cd opencv
$ mkdir build
$ cd build
$ cmake -D CMAKE_BUILD_TYPE=RELEASE -D CMAKE_INSTALL_PREFIX=/usr/local -D INSTALL_PYTHON_EXAMPLES=ON  -D OPENCV_EXTRA_MODULES_PATH=~/opencv_contrib/modules -D BUILD_EXAMPLES=ON ..
```

- python3等が正常に認識されていることを確認後，make

```
$ make -j4
```
- ここでfail
- これを試してみる
  - http://www.tech-tech.xyz/archives/python-opencv-pip-install.html
  - pipをupgrade
```
$ sudo pip install --upgrade pip
$ sudo pip install --upgrade wheel
$ sudo pip install opencv-contrib-python
```
  - ``Could not find any downloads that satisfy the requirement opencv-contrib-python`` とでて失敗＼(^o^)／

- whlファイルをPyPIからDLするのも試してみる
  - ここの``opencv_contrib_python-3.4.0.12-cp27-cp27m-manylinux1_i686.whl`` をDLする
  - https://pypi.python.org/pypi/opencv-contrib-python
  - DLは成功したが，``sudo pip3 install opencv_contrib_python-3.4.0.12-cp27-cp27m-manylinux1_i686.whl``とした場合，``opencv_contrib_python-3.4.0.12-cp27-cp27m-manylinux1_i686.whl is not a supported wheel on this platform.`` とでて失敗＼(^o^)／
  - 3.2.0.7も見つけたので試してみたがダメだった
    - https://pypi.python.org/pypi/opencv-contrib-python/3.2.0.7#downloads
